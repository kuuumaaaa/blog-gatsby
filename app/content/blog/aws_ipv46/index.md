---
title: AWS IPv4/IPv6の変換方法
date: "2022-06-18"
tags: ["aws","SAP"]
hero: ./AWS-Logo.svg
description: "search AWS IPv4 IPv6"
---

## はじめに
SAP対策で通信形式をIPv4対応の通信をIPv6に変換する方法について調べました。
もしご指摘あればご連絡いただければと思います。

## 前提
VPCにパブリックサブネット、プライベートサブネットを用意します。
VPCにはインタネットゲートウェイをアタッチします。
パブリックサブネットにインターネットゲートウェイ経由で通信するWEBサーバ、
プライベートサブネットにNATゲートウェイ経由で通信するデータベースサーバを作成されているものとします。
また、VPCとリソースはIPv4/IPv6のデュアルスタックモードで操作できるようにすることを最終目標とします。

## 方法
### ステップ 1: IPv6 CIDR ブロックを VPC およびサブネットと関連付ける
- "VPC"から IPv6に変更したいVPCを選択し[Add IPv6 CIDR (IPv6 CIDR の追加)] で追加。
- "VPC"から"サブネット”を選択し、IPv6に変更したいサブネットを選択し[Add IPv6 CIDR] で追加。
### ステップ 2: ルートテーブルを更新する
- パブリックサブネットのルートテーブルを更新。
  - 送信元を`::/0`と指定しインターネットゲートウェイ IDをターゲットとして選択
- プライベートサブネットのルートテーブルを更新します。送信元を`::/0`と指定しegress-onlyインターネットゲートウェイのIDを指定。
> ここで`::/0`はIPv6の設定であり、IPv4の`0.0.0.0/0`に相当するため全てのIPとマッチする。なので上記ではサブネットからインターネットゲートウェイに対して、IPv6のトラックを全てルーティングするような設定となっている。


> NATゲートウェイはIPv6に対応していない。そのため、IPv6経由のアウトバンド通信のみ有効にできるプライベートサブネット用のEgress-onlyインターネットゲートウェイを作成する。
### ステップ 3: セキュリティグループルールを更新する
- インスタンスがIPv6経由でトラフィックを送受信できるようにIPv6アドレスのルールを含むセキュリティグループを作成or更新。たとえば、80 403 ポートでIPv6を使用したい場合はセキュリティグループにソースを`::/0`ポート範囲を`80`,`443`としたルールを追加する
- カスタムネットワーク ACL ルールでサブネット間のトラフィックの流れを制御している場合は、IPv6 トラフィック上記と同様にルールを更新する。

詳細；https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/VPC_SecurityGroups.html
### ステップ 4: インスタンスタイプを変更する
- 現行世代のインスタンスタイプの場合,IPv6をサポートしているのでこの手順は不要
- 古いインスタンスタイプを使用している場合は互換等に気をつけて、インスタンスタイプを変更する。
### ステップ 5: IPv6 アドレスをインスタンスに割り当てる
- インスタンスを選択後、"Actions> Networking> ManagePrivate IP Address"の順に選択し、"IPv6 Addresses> Assign new IP"を選択。
- サブネットの範囲でIPv6アドレスを入力するorデフォルト値`Auto-Assign`として設定を更新をする。
### ステップ 6: (オプション) インスタンスに IPv6 を設定する
- Amazon Linux 2016.09.0 以降、Windows Server 2008 R2 以降、または Ubuntu Server 2018 以降のバージョンを使用している場合、インスタンスはIPv6に設定されているため追加手順がない。
- それ以外のOSを使用する場合はIPv6用の設定がされてない場合があるため下記を参照
詳細手順：https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-migrate-ipv6.html#vpc-migrate-ipv6-dhcpv6

### まとめ
基本的には既存の通信に関わる設定にIPv6の許可を加えるだけでよいということがわかった。
NATゲートウェイがIPv6に対応してないとのことなので、Egress-onlyインターネットゲートウェイを使用するなどの対応が必要なのがポイントそう。
また、IPv6について通信速度速いなどのふわっとした知識しかなかったため少し勉強になった。
## 参考
- https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-migrate-ipv6.html
- https://www.nic.ad.jp/ja/newsletter/No37/0800.html
- https://qiita.com/abetomo/items/37823ba2334328b35edf#:~:text=%3A%3A%2F0%20%E3%81%AFIPv6%E3%81%AE,0%20%E3%81%A8%E5%90%8C%E3%81%98%E6%84%8F%E5%91%B3%E3%81%A7%E3%81%99%E3%80%82